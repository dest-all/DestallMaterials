@using DestallMaterials.Blazor.Services

@inherits BaseInput<DateTime>
@inject IGlobalClickCatcher globalClickCatcher;

<StringInput InputLabel="@InputLabel" InvalidityCondition="v => _invalidityCondition(v)" Value=@ValueString OnValueSet="@_onValueSet"/>

@code{

    string _invalidityCondition(string value)
    {
        if (!DateTime.TryParse(value, out var date))
        {
            return "Not a valid date";
        }
        else
        {
            return InvalidityCondition(date);
        }
    }

    [Parameter]
    public Func<DateTime, string> InvalidityCondition { get; set; } = s => "";

    void _onValueSet(string value)
    {
        if (value == "∞")
        {
            Value = DateTime.MaxValue;
            OnValueSet(Value);
            return;
        }
        if (DateTime.TryParse(value, out var x))
        {
            Value = x;
            OnValueSet(x);
        }
    }

    public bool HasError => !string.IsNullOrEmpty(ErrorMessage);

    public string ErrorMessage => InvalidityCondition(Value);

    private string InputClass() => HasError ? "errored" : "";

    string ValueString => Value == DateTime.MaxValue ? "∞" : Value.ToString();

}